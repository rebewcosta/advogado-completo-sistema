
import { serve } from "https://deno.land/std@0.190.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import Stripe from "https://esm.sh/stripe@14.21.0";

// Configurar cabe√ßalhos CORS
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  // Lidar com solicita√ß√µes OPTIONS (preflight CORS)
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders, status: 204 });
  }

  try {
    console.log("üîÑ Iniciando criar-sessao-checkout");

    // Verificar se √© um teste de valida√ß√£o
    const body = await req.text();
    let requestData;
    
    try {
      requestData = body ? JSON.parse(body) : {};
    } catch (e) {
      requestData = {};
    }

    // Se for um teste simples, retornar sucesso
    if (requestData.test === true) {
      console.log("‚úÖ Teste de valida√ß√£o - retornando sucesso");
      return new Response(
        JSON.stringify({ 
          success: true, 
          message: "Fun√ß√£o de checkout operacional",
          test: true
        }),
        { 
          headers: { ...corsHeaders, "Content-Type": "application/json" }, 
          status: 200 
        }
      );
    }

    // Obter os dados do corpo da solicita√ß√£o
    const { nomePlano, valor, emailCliente, dominio } = requestData;
    
    // Detectar ambiente baseado no dominio ou headers
    const isProduction = !dominio?.includes('localhost') && 
                        !dominio?.includes('lovable.app') && 
                        !req.headers.get("origin")?.includes('localhost') &&
                        !req.headers.get("origin")?.includes('lovableproject.com');
    
    const modo = isProduction ? 'production' : 'test';
    
    // Validar os dados necess√°rios
    if (!nomePlano || !valor || !emailCliente) {
      console.error("‚ùå Dados incompletos:", { nomePlano, valor, emailCliente });
      return new Response(
        JSON.stringify({ error: "Dados incompletos para criar sess√£o" }),
        { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 400 }
      );
    }

    // Log do modo de opera√ß√£o
    console.log(`üîÑ Processando checkout - Email: ${emailCliente}, Plano: ${nomePlano}, Valor: ${valor}, Modo: ${modo}`);

    // Verificar autentica√ß√£o opcional (para usu√°rios j√° logados)
    let user = null;
    const authHeader = req.headers.get("Authorization");
    if (authHeader) {
      console.log("üîÑ Token de autentica√ß√£o detectado, verificando usu√°rio...");
      try {
        const supabase = createClient(
          Deno.env.get("SUPABASE_URL") ?? "",
          Deno.env.get("SUPABASE_ANON_KEY") ?? ""
        );

        const token = authHeader.replace("Bearer ", "");
        const { data: userData, error: userError } = await supabase.auth.getUser(token);
        
        if (!userError && userData.user?.email) {
          user = userData.user;
          console.log(`‚úÖ Usu√°rio autenticado detectado: ${user.email}`);
        } else {
          console.log("‚ö†Ô∏è Token inv√°lido ou usu√°rio n√£o encontrado, continuando como novo usu√°rio");
        }
      } catch (e) {
        console.log("‚ö†Ô∏è Erro ao verificar token, continuando como novo usu√°rio:", e);
      }
    } else {
      console.log("üìù Nenhum token de autentica√ß√£o - processando como novo usu√°rio");
    }
    
    // Obter a chave do Stripe do ambiente
    const stripeSecretKey = Deno.env.get("STRIPE_SECRET_KEY");
    if (!stripeSecretKey) {
      console.error("‚ùå STRIPE_SECRET_KEY n√£o configurada");
      return new Response(
        JSON.stringify({ error: "Chave de API do Stripe n√£o configurada" }),
        { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 500 }
      );
    }
    
    console.log(`üîÑ Iniciando Stripe no modo: ${modo.toUpperCase()}`);
    
    const stripe = new Stripe(stripeSecretKey, {
      apiVersion: "2023-10-16",
    });

    console.log("üîÑ Criando sess√£o de checkout...");
    
    // Determinar as URLs de sucesso e cancelamento
    const baseUrl = dominio || req.headers.get("origin") || "https://sisjusgestao.com.br";
    const successUrl = `${baseUrl}/pagamento?success=true`;
    const cancelUrl = `${baseUrl}/pagamento?canceled=true`;
    
    console.log(`üîó URLs - Success: ${successUrl}, Cancel: ${cancelUrl}`);
    
    // Usar o valor correto de R$ 37,00 (3700 centavos)
    const valorCorreto = 3700;
    
    // Determinar o Price ID baseado no ambiente
    const priceId = isProduction 
      ? 'price_1RfoO5Kr3xy0fCEP5COgihuw' // Price ID de produ√ß√£o
      : 'price_1QQKh6FJ3Y1S0P0BSZVwNKa6'; // Price ID de teste
    
    console.log(`üí∞ Usando Price ID: ${priceId} (modo: ${modo})`);
    
    // Criar a sess√£o de checkout usando o Price ID configurado
    const session = await stripe.checkout.sessions.create({
      payment_method_types: ["card"],
      customer_email: emailCliente,
      line_items: [
        {
          price: priceId,
          quantity: 1,
        },
      ],
      mode: "subscription",
      success_url: successUrl,
      cancel_url: cancelUrl,
      metadata: {
        email_cliente: emailCliente,
        plano: nomePlano,
        valor: valorCorreto.toString(),
        user_id: user?.id || 'novo_usuario',
        is_new_user: user ? 'false' : 'true'
      },
    });

    console.log(`‚úÖ Sess√£o criada com sucesso: ${session.id}`);

    // Retornar o ID da sess√£o e URL
    return new Response(
      JSON.stringify({ 
        sessionId: session.id, 
        url: session.url,
        modo: modo,
        valor: valorCorreto,
        priceId: priceId
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 200 }
    );

  } catch (error) {
    console.error("‚ùå Erro ao criar sess√£o de checkout:", error);
    
    const errorMessage = error instanceof Error ? error.message : "Erro interno do servidor";
    
    return new Response(
      JSON.stringify({ 
        error: errorMessage,
        message: "Houve um erro ao processar o pagamento"
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 500 }
    );
  }
});
